name: Gitpod Workspace on New Branch

on:
  create:

jobs:
  gitpod-workspace-creation:
    # This condition checks if the created reference is a branch and if it matches the 'dev/feature*' pattern
    if: github.ref_type == 'branch' && startsWith(github.ref, 'refs/heads/dev/feature')
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Setup Gitpod CLI
      run: |
        wget -O gitpod https://gitpod.io/static/bin/gitpod-cli-linux-amd64
        chmod +x gitpod
        ./gitpod login --token ${{ secrets.GITPOD_TOKEN }} --org ${{ secrets.GITPOD_ORG }}

    - name: Create a Gitpod workspace for the new branch
      run: |
        branchName=${GITHUB_REF#refs/heads/}
        repoFullName=${{ github.repository }}
        WORKSPACE_URL=$(./gitpod ws create github.com/$repoFullName/tree/$branchName --dont-wait)
        echo "WORKSPACE_URL=$WORKSPACE_URL" >> $GITHUB_ENV
